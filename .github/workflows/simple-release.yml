name: Simple Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build
        
    - name: Build package
      run: |
        echo "Building package..."
        python -m build
        echo "Build completed. Files in dist/:"
        ls -la dist/
        
    - name: Create standalone scripts
      run: |
        # åˆ›å»ºç‹¬ç«‹è¿è¡ŒåŒ…
        mkdir -p dist/standalone
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp -r depx dist/standalone/
        cp run_depx.py dist/standalone/
        cp interactive_depx.py dist/standalone/
        cp quick_start.py dist/standalone/
        cp install_and_run.sh dist/standalone/
        cp install_and_run.ps1 dist/standalone/
        cp STANDALONE_USAGE.md dist/standalone/README.md
        cp pyproject.toml dist/standalone/
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        cd dist/standalone
        tar -czf ../depx-standalone.tar.gz .
        zip -r ../depx-standalone.zip .
        cd ../..
        
        echo "Standalone packages created:"
        ls -la dist/
        
    - name: Generate release notes
      run: |
        echo "# Depx ${{ github.ref_name }} Release Notes" > release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸš€ ä¸€é”®è¿è¡Œ" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Linux/macOS:" >> release_notes.md
        echo '```bash' >> release_notes.md
        echo "curl -fsSL https://raw.githubusercontent.com/NekoNuo/depx/master/install_and_run.sh | bash" >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        echo "### Windows PowerShell:" >> release_notes.md
        echo '```powershell' >> release_notes.md
        echo "irm https://raw.githubusercontent.com/NekoNuo/depx/master/install_and_run.ps1 | iex" >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸ“¦ ä¸‹è½½æ–¹å¼" >> release_notes.md
        echo "" >> release_notes.md
        echo "1. **ä¸€é”®è¿è¡Œ** - ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ç›´æŽ¥è¿è¡Œ" >> release_notes.md
        echo "2. **ä¸‹è½½ç‹¬ç«‹åŒ…** - ä¸‹è½½ depx-standalone.zip æˆ– depx-standalone.tar.gz" >> release_notes.md
        echo "3. **pip å®‰è£…** - \`pip install depx\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## âœ¨ ä¸»è¦åŠŸèƒ½" >> release_notes.md
        echo "" >> release_notes.md
        echo "- ðŸ” **è·¨è¯­è¨€åŒ…æœç´¢** - æ”¯æŒ npmã€pipã€cargoã€yarn" >> release_notes.md
        echo "- ðŸ“¦ **æ™ºèƒ½åŒ…å®‰è£…** - è‡ªåŠ¨æ£€æµ‹é¡¹ç›®ç±»åž‹" >> release_notes.md
        echo "- ðŸ”„ **åŒ…æ›´æ–°ç®¡ç†** - æ£€æŸ¥å’Œæ›´æ–°è¿‡æ—¶ä¾èµ–" >> release_notes.md
        echo "- ðŸ“Š **ä¾èµ–åˆ†æž** - åˆ†æžé¡¹ç›®ä¾èµ–ç»“æž„" >> release_notes.md
        echo "- ðŸ§¹ **ä¾èµ–æ¸…ç†** - æ¸…ç†æœªä½¿ç”¨çš„ä¾èµ–" >> release_notes.md
        echo "- ðŸŒ **å¤šè¯­è¨€ç•Œé¢** - æ”¯æŒä¸­è‹±æ–‡" >> release_notes.md
        
        echo "Release notes generated:"
        cat release_notes.md
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/*.whl
          dist/*.tar.gz
          dist/depx-standalone.zip
          dist/depx-standalone.tar.gz
        body_path: release_notes.md
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
